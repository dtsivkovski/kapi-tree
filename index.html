<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kapi Epsilon Chapter Tree</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.30.2/cytoscape.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/dagre@0.7.4/dist/dagre.js"></script>
    <script src="https://cytoscape.org/cytoscape.js-dagre/cytoscape-dagre.js"></script>
    <style>
        body {
            height: 100vh;
        }
    </style>
</head>
<body>

    <div id="cy" style="width: 100%; height: 100%;"></div>

    <script>

        // Function to generate a random color for each family
        function generateRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function sanitizeId(name) {
            return name.replace(/[^a-zA-Z0-9]/g, '_'); // Replace non-alphanumeric characters with underscores
        }

        // Map to store family colors
        const familyColors = {"FYGS": "#fc6b03", "Tapout": "#8ec6fa", "House":"#c07cf7", "Camp": "#83bd7b"};

        // Function to fetch and parse CSV file
        function loadCSV() {
            Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vRIgDFPh86OjayGbWa6dlMjhvdMw6jruCetNiaj3coF36C4no2oxfrx3dY_Klle8tYqxELNNaKMgtig/pub?output=csv', {
                download: true,
                header: true, // Assume the first row contains column headers
                complete: function(results) {
                    const data = results.data;
                    processData(data);
                },
                error: function(err) {
                    console.error('Error loading CSV:', err);
                }
            });
        }

        // Function to process the CSV data and generate the Cytoscape elements
        function processData(data) {
            const elements = [];

            data.forEach(function(person) {
                const name = person.name;
                const parent = person.parent || 'Unknown';
                const family = person.family || 'Unknown';
                const pc = person.pc || 'Unknown';


                const sanitizedName = sanitizeId(name);
                const sanitizedParent = sanitizeId(parent);

                // Assign a color to the family if not already assigned
                if (!familyColors[family]) {
                    familyColors[family] = generateRandomColor();
                }

                // Create a node for each person
                elements.push({
                    data: {
                        id: sanitizedName,
                        name: name,
                        family: family,
                        pc: pc,
                        familyColor: familyColors[family]
                    }
                });

                // Create an edge from parent to child if the parent exists
                if (parent !== 'Unknown') {
                    elements.push({
                        data: { source: sanitizedParent, target: sanitizedName }
                    });
                }
            });

            console.log(elements);

            // Initialize Cytoscape with the nodes and edges
            var cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': 'data(familyColor)',
                            'label': function(ele) {
                                if (ele.data('pc') === 'Unknown') {
                                    return ele.data('name') + ' (' + ele.data('family') + ')';
                                }
                                return ele.data('name') + ' (' + ele.data('pc') + ', ' + ele.data('family') + ')';
                            },
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'border-width': 0,
                            'border-color': '#000',
                            'font-size': '10vw',
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 8,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle'
                        }
                    }
                ],
                layout: {
                    name: 'dagre',
                    rankDir: 'TB',  // Top to bottom
                    nodeSep: 150,    // Horizontal spacing
                    rankSep: 50,
                    animate: true,
                }
            });
        }

        // Load CSV and initialize the visualization
        window.addEventListener('DOMContentLoaded', loadCSV);
    </script>

</body>
</html>